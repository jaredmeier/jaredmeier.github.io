<!DOCTYPE HTML>
<html>

<head>
	<title>crossword</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta property="og:title" content="crossword">
	<meta property="og:description" content="crossword">
	<link rel="icon" href="./images/jared-meier-cropped.png" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Tiro+Gurmukhi&display=swap" rel="stylesheet">

	<link rel="stylesheet" type="text/css" href="styles.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
	<div class="container-fluid grid" tabindex="0">
	</div>
	<div class="button-container py-3">
		<button class="arrow-button">
			<i class="fa fa-arrow-up"></i>
		</button>		
	</div>
	

	<script>
		let selected = null;

		// horizontal auto-focus 0; vertical 1
		let mode = 0;

		const button = document.querySelector('.arrow-button');
		button.addEventListener('click', (_event) => {
			toggleMode();
		});

		const gridContainer = document.querySelector('.grid');
		const size = 15;

		let counter = 1;
		for (let i = 0; i < size; i++) {
			const row = document.createElement('div');
			row.classList.add('row');
			gridContainer.appendChild(row);
			
			for (let j = 0; j < size; j++) {
				const squareContainer = document.createElement('div');
				squareContainer.classList.add('square-container', 'col');
				row.appendChild(squareContainer);

				const div = document.createElement('div');
				div.classList.add('square-number');
				div.innerHTML = counter;
				squareContainer.appendChild(div);

				const square = document.createElement('input');
				square.classList.add('square', 'col-sm-1');
				square.setAttribute('type', 'text');
				square.setAttribute('maxlength', '1');
				squareContainer.appendChild(square);

				counter++;
			}
		}
		
		const rows = document.querySelectorAll('.row');
		const squares = document.querySelectorAll('.square');

		function toggleSelected(square) {
			if (selected) {
				selected.classList.remove('selected');
			}

			if (!square) return;

			if (!square.classList.contains('blacked-out')) {
				selected = square;
				square.classList.add('selected');
			};
		}

		function toggleMode() {
			if (mode === 0) {
				mode = 1;
			} else {
				mode = 0;
			}
			button.classList.toggle('down');
			if (selected) highlightDirection(selected);
		}

		function setMode(val) {
			mode = val;
			if (mode === 1 && !button.classList.contains('down')) button.classList.add('down');
			if (mode === 0 && button.classList.contains('down')) button.classList.remove('down');

			if (selected) highlightDirection(selected);
		}

		function rowNode(square) {
			return square.parentNode.parentNode;
		}

		function highlightDirection(square) {
			clearHighlights();
			if (mode === 0) {
				highlightRow(square);
			} else {
				highlightCol(square);
			}
		}

		function highlightRow(square) {
			const rowSquares = rowNode(square).querySelectorAll('.square');
			for (let i = 0; i < rowSquares.length; i++) {
				rowSquares[i].classList.add('highlighted');
			}
		}

		function highlightCol(square) {
			const childIdx = childIndex(square);
			rows.forEach((row) => {
				const square = row.querySelectorAll('.square')[childIdx];
				square.classList.add('highlighted');
			});
		}

		function clearHighlights() {
			squares.forEach((square) => square.classList.remove('highlighted'));
		}

		function childIndex(square) {
			const children = rowNode(square).querySelectorAll('.square');

			let childIdx = null;
			for (let i = 0; i < children.length; i++) {
				if (children[i] === square) {
					childIdx = i;
					break;
				}
			}
			return childIdx;
		}

		function focusNextOrPrev(square, prev) {
			if (mode === 0) {
				const rowSquares = rowNode(square).querySelectorAll('.square');
				let idx = childIndex(square);
				let nextSquare;
				while (!nextSquare || (nextSquare && nextSquare.classList.contains('blacked-out'))) {
					idx = prev ? idx - 1 : idx + 1;

					if (idx < 0) break;

					nextSquare = rowSquares[idx];

					if (!nextSquare) break;
				}
				if (nextSquare) {
					nextSquare.focus();
				}
			} else {
				const row = rowNode(square);
				const childIdx = childIndex(square);
				let currRow = row;
				let nextRow;
				let nextSquare;
				while (!nextSquare || (nextSquare && nextSquare.classList.contains('blacked-out'))) {
					nextRow = prev ? currRow.previousElementSibling : currRow.nextElementSibling;

					if (!nextRow) break;

					nextSquare = nextRow.querySelectorAll('.square')[childIdx];
					currRow = nextRow;
				}

				if (nextSquare) {
					nextSquare.focus();
				}
			}
		}

		function focusNext(square) {
			focusNextOrPrev(square, false);
		}

		function focusPrevious(square) {
			focusNextOrPrev(square, true);
		}
		
		squares.forEach((square) => {
			square.addEventListener('focus', (event) => {
				toggleSelected(square);
				highlightDirection(square);
			});

			square.addEventListener('dblclick', (event) => {
				square.classList.toggle('blacked-out');
				if (square.classList.contains('blacked-out')) {
					square.readOnly = true;
				} else {
					square.readOnly = false;
				}

				if (selected) {
					selected.classList.remove('selected');
					selected = null;
				}
			});

			square.addEventListener('keydown', (event) => {
				switch(event.keyCode) {
					// change input direction when \ is pressed
					case 220:
						event.preventDefault();
						toggleMode();
						break;
					// go back on delete/backspace
					case 8:
						event.preventDefault();
						square.value = null;
						focusPrevious(square);
						break;
					// handle arrow keys
					case 37:
						event.preventDefault();
						setMode(0);
						focusPrevious(square);
						break;
					case 38:
						event.preventDefault();
						setMode(1);
						focusPrevious(square);
						break;
					case 39:
						event.preventDefault();
						setMode(0);
						focusNext(square);
						break;
					case 40:
						event.preventDefault();
						setMode(1);
						focusNext(square);
						break;
				}

				if (event.key.match(/^[a-zA-Z]$/)) {
					event.preventDefault();
					square.value = event.key;

					focusNext(square);
				}
			});

		});
	</script>
</body>

</html>